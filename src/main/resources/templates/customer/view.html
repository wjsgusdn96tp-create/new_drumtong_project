<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/DrumtongCss/customer_view.css">
</head>

<body>
	<th:block th:include="common/header"></th:block>
    <div class="all-wrap">
        <div class="all-content-wrap">
            <div>
                <table class="tbl" style="width: 100%" >
                    <tr>
                        <th style="width: 15%">유형</th>
                        <td style="width: 30%" th:text="${c.customerCategory}"></td>
                        <th style="width: 15%">제목</th>
                        <td style="width: 40%" th:text="${c.customerTitle}"></td>
                    </tr>
                    <tr>
                        <th>첨부파일</th>
                        <td colspan="3">
					        <th:block th:if="${!c.fileList.isEmpty()}">
					            <div th:each="file : ${c.fileList}">
					                <span th:text="${file.fileName}"></span>
					            </div>
					        </th:block>
					
					        <th:block th:if="${c.fileList.isEmpty()}">
					            <span>첨부된 파일이 없습니다.</span>
					        </th:block>
					    </td>
                    </tr>
                    <tr>
                        <td class="content" colspan="4" th:utext="${c.customerContent}"></td>
                    </tr>
                </table>
                <div>
                   <div>
                   		<th:block th:if="${session.member != null and (session.member.memberNickname == c.customerNickname or session.member.memberGrade == '관리자')}">
				            <form action="/customer/insertComment" method="post">	
				                <ul class="comment-ul">
				                    <li>
				                        <span th:if="${session.member.memberGrade == '관리자'}" class="material-icons" style="font-size: 50px;">manage_accounts</span>
				                        <span th:if="${session.member.memberGrade != '관리자'}" class="material-icons" style="font-size: 50px;">self_improvement</span>
				                    </li>
				                    <li>
				                        <input type="hidden" name="customerWriterNo" th:value="${session.member.memberNo}">
				                        <input type="hidden" name="customerServiceRef" th:value="${c.customerNo}">
				                        <div class="input-item">
				                            <textarea class="ccc" style="background-color: var(--main2);" name="commentContent" placeholder="답변을 입력하세요."></textarea>
				                        </div>
				                    </li>
				                    <li>
				                        <button type="submit" class="comment-btn">댓글등록</button>
				                    </li>
				                </ul>
				            </form>
				        </th:block>
                        <div class="gong"></div>
						<!--댓글출력 -->
                        <th:block th:each="cc : ${c.commentList}" th:if="${cc.customerCommentRef == 0 or cc.customerCommentRef == null}">
				            <ul class="comment-ul-road">
				                <li style="font-weight: bold; width: 120px; text-align: center;">
				                    <th:block th:each="m : ${allMembers}" th:if="${m.memberNo == cc.customerWriterNo}">
				                        <span th:if="${m.memberGrade == '관리자'}">관리자</span>
				                        <span th:if="${m.memberGrade != '관리자'}" th:text="${m.memberNickname}"></span>
				                    </th:block>
				                </li>
				                <li>
				                    <div class="input-item">
				                        <p class="comment-content-p" th:text="${cc.commentContent}"></p>
				                        <div class="input-item" style="display:none;">
								            <textarea class="ccc" name="commentContent"></textarea>
								        </div>
				                    </div>
				                </li>
				                <li>
				                    <th:block th:if="${session.member != null and session.member.memberNo == cc.customerWriterNo}">
								        <button th:onclick="|modifyComment(this, ${c.customerNo}, ${cc.commentNo})|">수정</button>
								        <button class="delComment" th:value="${cc.commentNo}" th:onclick="|deleteComment(this)|">삭제</button>
								    </th:block>
				                    <div>
				                        <a class="recShow" th:if="${session.member != null and (session.member.memberNickname == c.customerNickname or session.member.memberGrade == '관리자')}">댓글달기</a>
				                    </div>
				                </li>
				            </ul>
	                        <!-- 대댓글 -->
						    <div class="inputRecommentBox" style="display:none;">
						        <form action="/customer/insertComment" method="post">
						            <ul class="comment-ul-ref">
						                <li>
						                    <span class="material-icons" style="font-size: 40px;">subdirectory_arrow_right</span>
						                </li>
						                <li>
						                    <input type="hidden" name="customerCommentRef" th:value="${cc.commentNo}">
						                    
						                    <input type="hidden" name="customerWriterNo" th:value="${session.member.memberNo}">
						                    <input type="hidden" name="customerServiceRef" th:value="${c.customerNo}">
						                    <div class="input-item">
						                        <textarea class="ccc" name="commentContent" placeholder="댓글을 입력하세요."></textarea>
						                    </div>
						                </li>
						                <li>
						                    <button type="submit" class="comment-btn">답글등록</button>
						                </li>
						            </ul>
						        </form>
						    </div>
						    <!-- 대댓글 출력 -->
						    <th:block th:each="re : ${c.commentList}" th:if="${re.customerCommentRef == cc.commentNo}">
						        <ul class="comment-ul-ref">
						            <li style="font-weight: bold; width: 120px; text-align: center;">
						                <span class="material-icons" style="font-size: 40px;">subdirectory_arrow_right</span>
						                <th:block th:each="m : ${allMembers}" th:if="${m.memberNo == re.customerWriterNo}">
						                    <span th:if="${m.memberGrade == '관리자'}">관리자</span>
						                    <span th:unless="${m.memberGrade == '관리자'}" th:text="${m.memberNickname}"></span>
						                </th:block>
						            </li>
						            <li>
						                <p class="comment-content-p" th:text="${re.commentContent}"></p>
						                <div class="input-item" style="display:none;">
						                    <textarea class="ccc" name="commentContent"></textarea>
						                </div>
						            </li>
						            <li>
						                <th:block th:if="${session.member != null and session.member.memberNo == re.customerWriterNo}">
									        <button th:onclick="|modifyComment(this, ${c.customerNo}, ${re.commentNo})|">수정</button>
									        <button class="delComment" th:value="${re.commentNo}" th:onclick="|deleteComment(this)|">삭제</button>
									    </th:block>
						            </li>
						        </ul>
						    </th:block>
                        </th:block>
                    </div>
                </div>
                <div class="rank">
                    <span>관리자 댓글에 대한 평점을 남겨주세요.</span>
                </div>
                <div class="star-wrap" th:classappend="${session.member != null and session.member.memberGrade == '관리자'} ? 'admin-view' : ''">
                    <span class="material-icons">star</span>
                    <span class="material-icons">star</span>
                    <span class="material-icons">star</span>
                    <span class="material-icons">star</span>
                    <span class="material-icons">star</span>
                </div>
                <p class="star-rank">0점</p>
                <div class="modydele">
                    <th:block class="modydele-th">
                            <a href="#" class="btn btn1">수정</a>
                            <button class="btn btn2">삭제</button>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
    <th:block th:include="common/footer"></th:block>
    <script>
    $(document).ready(function(){
        const savedRating = [[${c.customerStar}]]; // DB에 저장된 별점 값을 가져옴
        if(savedRating > 0){
            displaySavedRating(savedRating);
        }
    });

    function displaySavedRating(rating) {
        const stars = $(".star-wrap>span");
        stars.css("color", "var(--gray6)");
        const targetStar = stars.eq(rating - 1);
        targetStar.prevAll().css("color", "var(--main4)");
        targetStar.css("color", "var(--main4)");
        $(".star-rank").text(rating + "점");
    }

    $(".star-wrap>span").on("click",function(){
    	
    	if ($(this).parent().hasClass('admin-view')) {
            return; 
        }
    	
        const index = $(this).index();
        const newRating = index + 1;
        const customerNo = [[${c.customerNo}]];

        $.ajax({
            url: "/customer/updateStar",
            type: "post",
            data: {
                customerNo: customerNo,
                customerStar: newRating
            },
            success: function(response){
                if(response === "success"){
                    alert("별점이 저장되었습니다.");
                    displaySavedRating(newRating);
                } else {
                    alert("별점 저장 실패");
                }
            },
            error: function(){
                alert("별점 저장 오류");
            }
        });
    });
    
    $(".recShow").on("click", function() {
        const index = $(".recShow").index(this);
        if ($(this).text() === "댓글달기") {
            $(this).text("취소");
        } else {
            $(this).text("댓글달기");
        }
        $(".inputRecommentBox").eq(index).toggle();
    });
    
    function deleteComment(obj) {
        const clickedButton = $(obj);
        const commentNo = clickedButton.val();

        if(!confirm("댓글을 삭제하시겠습니까?")) {
            return;
        }
        
        $.ajax({
            url: "/customer/deleteComment",
            type: "post",
            data: { commentNo: commentNo },
            success: function(response) {
                if(response === "success") {
                    alert("댓글이 삭제되었습니다.");
                    const parentUl = clickedButton.closest('ul');
                    if (parentUl.hasClass('comment-ul-ref')) {
                        parentUl.remove();
                    } else {
                        parentUl.nextUntil('.comment-ul-road').remove();
                        parentUl.remove();
                    }
                } else {
                    alert("댓글 삭제 실패");
                }
            },
            error: function(){ alert("댓글 삭제 오류"); }
        });
    }
    
    function modifyComment(obj, customerNo, commentNo) {
        const modifyBtn = $(obj);
        const delBtn = modifyBtn.next('.delComment');
        const commentLi = modifyBtn.closest('li');
        const contentLi = commentLi.prev('li');
        const contentP = contentLi.find('.comment-content-p');
        const contentTextareaDiv = contentLi.find('.input-item[style*="display:none"]');
        const recShowLink = commentLi.find('.recShow');

        contentTextareaDiv.find('textarea').val(contentP.text());
        contentP.hide();
        contentTextareaDiv.show();
        
        modifyBtn.text("수정완료");
        modifyBtn.attr("onclick", `modifyComplete(this, ${customerNo}, ${commentNo})`);

        delBtn.text("수정취소");
        delBtn.attr("onclick", `cancelModify(this, ${customerNo}, ${commentNo})`);

        if (recShowLink.length > 0) {
            recShowLink.hide();
        }
    }

    function modifyComplete(obj, customerNo, commentNo) {
        const form = $('<form>');
        form.attr("action", "/customer/updateComment").attr("method", "post");
        form.append($('<input>').attr("type", "hidden").attr("name", "commentNo").val(commentNo));
        form.append($('<input>').attr("type", "hidden").attr("name", "customerServiceRef").val(customerNo));
        const contentTextarea = $(obj).closest('li').prev('li').find('textarea').clone();
        form.append(contentTextarea);
        $('body').append(form);
        form.submit();
    }

    function modifyCancel(obj, customerNo, commentNo) {
        const cancelBtn = $(obj);
        const modifyBtn = cancelBtn.prev();
        const commentLi = cancelBtn.closest('li');
        const contentLi = commentLi.prev('li');
        const contentP = contentLi.find('.comment-content-p');
        const contentTextareaDiv = contentLi.find('.input-item[style*="display:none"]');
        const recShowLink = commentLi.find('.recShow');

        contentP.show();
        contentTextareaDiv.hide();
        
        modifyBtn.text("수정");
        modifyBtn.attr("onclick", `modifyComment(this, ${customerNo}, ${commentNo})`);

        cancelBtn.text("삭제");
        cancelBtn.attr("onclick", `deleteComment(this)`);

        if (recShowLink.length > 0) {
            recShowLink.show();
        }
    }

    </script>
</body>
</html>