<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="/DrumtongJs/news.js"></script>
<link rel="stylesheet" href="/DrumtongCss/modal.css">
<link rel="stylesheet" href="/DrumtongCss/news.css">
<style>
	.item-img-div{
		width: 200px;
		height: 250px;
		margin: 0 auto;
		overflow: hidden
	}
	.item-img-div:hover img{
	transition-duration: 0.5s;
	width: 95%;
}
	.news-title:hover {
		cursor: pointer;
	}
	.item-img-div:hover{
		cursor: pointer;
	}
	
	
	.text-warp{
		margin-top: 10px;
	}
	.news-list{
		overflow: hidden;
		margin: 40px 0;
	}
	.news-item{
		padding: 15px;
		width: calc(800px/3);
		float: left;
		padding: 10px;
		margin: 10px 0;
		box-sizing: border-box;
	}
	
	.discountDiv{
		height: 10px;
		margin-bottom : 20px;
	}
	
	.tabSelect{
		background-color: var(--main3)
	}
	.news-title{
		text-align: left;
	}
	.inner>img{
		width: 100%;
	}
	.newDelete{
		margin-right:5px;
	}
	.newsDelete{
		margin-left:10px;
	}
</style>
</head>
<body>
	<th:block th:include="common/header"></th:block>
	<div class="content-wrap">
				
		<div id="modal" class="dialog">
			<div class="tb">
				<div class="inner" style="max-width: 800px;">
					<div class="top">
						<div class="title">모달창 제목</div>
						<a href="#" class="modal-close">닫기</a>
					</div>
					<img src="/img/banner/poster.jfif" class="ct">
				</div>
			</div>
		</div>
		
		
		
		<div id="main-news">
			<img src="/img/news/main_promotion3.jpg" class="main-news3">
			<div th:if="${session.member != null && session.member.memberGrade == '관리자'}" class="btn-div">
				<a href="/" class="btn write-btn" style="float:right;">이미지 수정</a>	<!-- 관리자만 노출 -->
			</div>
		</div>
		<div class="tab">
			<ul class="first-tab">
				<li th:styleappend="${tab=='all'?'background-color:var(--main3)':'background-color:var(--main1)'}">전체보기</li>
				<li th:styleappend="${tab=='event'?'background-color:var(--main3)':'background-color:var(--main1)'}">이벤트</li>
				<li th:styleappend="${tab=='promotion'?'background-color:var(--main3)':'background-color:var(--main1)'}">프로모션</li>
			</ul>
			<span></span>
			<ul  class="second-tab">
				<li>공지사항</li>
			</ul>
		</div>
		
		<div class="btn-div">
			<div th:if="${session.member != null && session.member.memberGrade == '관리자'}" style="overflow:hidden;">
				<a href="/news/noticeWriteFrm" class="btn write-btn">공지사항 쓰기</a>
				<a href="/news/writeFrm" class="btn write-btn">NEWS 쓰기</a>					
			</div>
		</div>
		
		<div class="list">
			<ul class="news-list"> 
			
			
			</ul>
			<div id="add-search"> 		
				<button class="btn" id="more-btn">더보기</button>
			</div>
		</div>	
		
		<div class="notice_wrap close">
			<div class="notice-list">
				<table border=1>
					<tr>
						<th style="width:10%">번호</th>
						<th style="width:50%">글 제목</th>
						<th style="width:15%">작성일</th>
						<th style="width:10%">조회수</th>
						<th>수정</th> <!-- 관리자만 노출 -->
						<th>삭제</th> <!-- 관리자만 노출 -->
						
					</tr>
					<tr th:each="notice : ${notice}">
						<td th:text="${notice.noticeNo}"></td>
						<td> <a th:href="@{/news/noticeView(noticeNo=${notice.noticeNo})}" th:text="${notice.title}"></a></td>
						<td th:text="${notice.writeDate}"></td>
						<td>999</td>
						<td><button>수정</button></td> <!-- 관리자만 노출 -->
						<td><button>삭제</button></td> <!-- 관리자만 노출 -->
					</tr>
				</table>
			</div>
			<div class= page-item id="pageNavi" th:utext="${pageNavi}"></div>
		</div>
	</div>
	<th:block th:include="common/footer"></th:block>
	
	<script th:inline="javascript">
		const totalCount = [[${totalCount}]]; 	// news 게시물 갯수
		let currentCount = 0;					// 현재까지 읽어온 게시물 수
		let start = 1;							// 게시물의 시작 번호
		const amount = 6;						// 더보기 한번 클릭 시 추가로 가져올 게시물 수 
		
		window.onload=function(){
			document.getElementById('more-btn').click();
	
		}
		
		const memberGrade = [[${session.member?.memberGrade}]];
		
		
		
		$(".first-tab>li").on("click", function(){
			$(".notice_wrap").addClass("close");
			$(".list").removeClass("close");
			$(".second-tab>li").css("backgroundColor","var(--main1)");
			$(".first-tab>li").css("backgroundColor","var(--main1)");
			const tabSelect = $(this).text();
			let tab = "";
			if(tabSelect==="이벤트"){
				tab="event"
			}else if(tabSelect==="프로모션"){
				tab="promotion" 
			}else {
				tab="all"
			}
			location.href="/news/list?noticeReqPage=1&tab="+tab;
						
		});
		
		
		$("#more-btn").on("click",function() {
			$.ajax({
				url: "/news/more",
				type: "get",
				data: {start: start, amount : amount, tab : [[${tab}]]},
				success : function(newsList){
					for(let i=0; i<newsList.length ; i++){

						const n = newsList[i];
												
						const li = $("<li>");
						li.addClass("news-item");
						
						
						
						const imgDiv = $("<div>");
						imgDiv.addClass("item-img-div");
						const img = $("<img>");
						img.attr("src", "/news/image/"+n.image);
						// <img src="에서 조회해온 이미지path">
						imgDiv.append(img);
												
						const textWrap = $("<div>");
						textWrap.addClass("text-warp");
						const titleDiv = $("<div>");
						titleDiv.addClass("news-title");
						const typeSpan = $("<span>");
						typeSpan.addClass("type");
						typeSpan.text("["+n.type+"] ");
						const titleSpan = $("<span>");
						titleSpan.text(n.title);
						titleDiv.append(typeSpan).append(titleSpan);
						
						const smallDiv = $("<div>");
						smallDiv.addClass("list-small");
						
						const dateSpan = $("<span>");
						dateSpan.addClass("date");
						if(n.type === '이벤트'){
							const startDateSpan = $("<span>");
							startDateSpan.text(n.startDate);
							const middleDateSpan = $("<span>");
							middleDateSpan.text(" ~ ");
							const endDateSpan = $("<span>");
							endDateSpan.text(n.endDate);
							dateSpan.append(startDateSpan).append(middleDateSpan).append(endDateSpan);
						}
						
						const likeSpan = $("<span>");
						likeSpan.addClass("like");
						const likeCountSpan = $("<span>");
						likeCountSpan.addClass("likeCount").text(n.likeCount);
						
						const likeIconSpan = $("<span>");
						if(n.isLike ===1) {
							likeIconSpan.addClass("material-icons").addClass("likeBtn").text("favorite");								
						} else{
							likeIconSpan.addClass("material-icons").addClass("likeBtn").text("favorite_border");
						}
						
							
						const newsNo = $("<span>");
						newsNo.text(n.newsNo).addClass("close").addClass("newsNo");
						
						likeSpan.append(likeIconSpan).append(newsNo).append(likeCountSpan);
						smallDiv.append(dateSpan).append(likeSpan);
						textWrap.append(titleDiv).append(smallDiv)
						
						if(memberGrade == '관리자') {
							const btnDiv = $("<div>");
							const newsUpdate = $("<a>");
							newsUpdate.addClass("newsUpate").addClass("btn");
							newsUpdate.text("News 수정");
							newsUpdate.attr("href","/news/updateNews?newsNo="+n.newsNo);
							const newsDelete = $("<a>");
							newsDelete.addClass("newsDelete").addClass("btn");
							newsDelete.text("News 삭제");
							newsDelete.attr("href","/news/deleteNews?newsNo="+n.newsNo);
							btnDiv.append(newsUpdate).append(newsDelete);
							textWrap.append(btnDiv);
							
						}
						
						li.append(imgDiv).append(textWrap);
												
												
						$(".news-list").append(li);
						
						
					}
					
					start += amount; 
					currentCount += newsList.length;  
					if(currentCount === totalCount) {
						$("#more-btn").remove();
					}
				},
				error : function(){
					console.log("에러");
				}
			})
		});
		
		

		
		$(".modal-close").on('click', function(e){
			e.preventDefault();
			const modal = $(this).parents('.dialog');
			modal.fadeOut();
		});
		
		
		$(document).on("click",".likeBtn",function(){
			const currentText = $(this).text();
			const isLike = (currentText === "favorite")?1:0;
			const newsNo =$(this).next().text();

			$.ajax({
				url : "/news/likepush",
				data : {newsNo : newsNo, isLike : isLike},
				type : "post",
				dataType: 'json',
				context: this,
				success : function(data){
					if($(this).text() === "favorite") {
						$(this).text("favorite_border");
					} else {
						$(this).text("favorite");						
					}
					$(this).next().next().text(data);
				}
			})
		});
	

	$(".second-tab>li").on("click", function(){
		$(".notice_wrap").removeClass("close");
		$(".list").addClass("close");
		$(".second-tab>li").css("backgroundColor","var(--main3)");
		$(".first-tab>li").css("backgroundColor","var(--main1)");
	});
	
	
	$(document).on("click",".item-img-div",function(){
		const newsNo = $(this).parent().find('.newsNo').text();
		location.href="/news/view?newsNo="+newsNo;
	});
	

	$(document).on("click",".news-title",function(){
		const newsNo = $(this).parent().find('.newsNo').text();
		location.href="/news/view?newsNo="+newsNo;
	});
		
	</script>
</body>
</html>