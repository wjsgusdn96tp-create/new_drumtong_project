<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.iei.customer.dao.CustomerDao">
	
	<select id="selectCustomerList" resultType="customer">
		SELECT *
			FROM (
			    SELECT rownum AS rnum, c.*
			    FROM (
			        SELECT customer_no, customer_category, customer_nickname, customer_title, customer_date
			        FROM customer_service_tbl
			        <where>
			        	<if test="memberGrade != null and memberGrade != '관리자'">
			        		customer_nickname = #{memberNickname}
			        	</if>
			        	<if test="category != null">
		                    AND customer_category = #{category}
		                </if>
			        </where>
			        <choose>	
			        	<when test="sort == null">
			        		ORDER BY customer_no DESC
			        	</when>
			        	<when test="sort.equals('lastest')">
			        		ORDER BY customer_no DESC
			        	</when>
			        	<when test="sort.equals('oldest')">
			        		order by customer_no asc
			        	</when>
			        	<when test="sort.equals('abc')">
			        		order by customer_title asc, customer_no asc
			        	</when>
			        </choose>
			    ) c
			)
			WHERE #{start} <![CDATA[ <= ]]> rnum and rnum <![CDATA[ <= ]]> #{end}
	</select>
	
	<select id="selectCustomerTotalCount" resultType="int">
		select count(*) from customer_service_tbl
		<where>
	        <if test="memberGrade != null and memberGrade != '관리자'">
	            customer_nickname = #{memberNickname}
	        </if>
	        <if test="category != null">
	            AND customer_category = #{category}
	        </if>
    	</where>
	</select>
	

	<select id="selectOneCustomer" resultType="customer">
	    select
	        customer_no,         
	        customer_nickname, 
	        customer_category,   
	        customer_title,      
	        customer_content,    
	        customer_date,		
	        customer_star       
	    from
	        customer_service_tbl
	    where
	        customer_no = #{customerNo}
	</select>

	<insert id="insertCustomer">
		insert into customer_service_tbl 
			values(#{customerNo}, #{customerNickname}, #{customerCategory}, #{customerTitle}, #{customerContent}, to_char(sysdate, 'yyyy-mm-dd'), #{customerStar})
	</insert>
	
	<select id="getCustomerNo" resultType="int">
		select customer_service_seq.nextval from dual
	</select>
	
	<insert id="insertCustomerFile">
		insert into customer_service_file
		values(customer_service_file_seq.nextval, #{customerNo}, #{fileName}, #{filePath})
	</insert>
	
	<select id="selectCustomerFiles" resultType="customerServiceFile">
		select * from customer_service_file where customer_no = #{customerNo}
	</select>
	
	<delete id="deleteCustomerFiles">
		delete from customer_service_file where customer_no = #{customerNo}
	</delete>
	
	<delete id="deleteCustomer">
        DELETE FROM customer_service_tbl WHERE customer_no = #{customerNo}
    </delete>
</mapper>
